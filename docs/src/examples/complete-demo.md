# Complete Pipeline Demo

This example demonstrates the full AIGC hero pipeline using the sample character image. It showcases every stage from image input to trained policy output.

## Overview

The complete demo processes a character through all six pipeline stages:

1. **Image-to-3D Generation**: Convert character image to 3D mesh
2. **Part Decomposition**: Split mesh into semantic body parts
3. **Skeleton Rigging**: Generate articulated bone structure
4. **URDF Generation**: Create physics-ready robot description
5. **Simulation Setup**: Deploy in MuJoCo environment
6. **RL Training**: Train locomotion policy

## Running the Demo

### Prerequisites

Ensure you have Tung Playground installed:

```bash
git clone https://github.com/ruziniuuuuu/tung_playground.git
cd tung_playground
uv sync
uv pip install -e .
```

### Execute the Demo

```bash
python examples/full_pipeline_demo.py
```

### Expected Output

```
🚀 Starting Tung Playground Full Pipeline Demo
============================================================
📸 Creating hero: tung_sahur_demo
✅ Created hero: tung_sahur_demo (ID: 12345678...)
📁 Hero directory: heroes/tung_sahur_demo
⚙️  Loaded configuration with 6 sections
🔧 Building complete pipeline...
✅ Pipeline configured with 6 stages:
   1. generation
   2. decomposition
   3. rigging
   4. urdf
   5. simulation
   6. training

🎬 Executing complete pipeline...
============================================================

📊 Pipeline Results:
============================================================
✅ Stage 1: generation
   Status: COMPLETED
   Time: 1.02s
   Outputs: ['mesh_path', 'quality_score']

✅ Stage 2: decomposition
   Status: COMPLETED
   Time: 0.83s
   Outputs: ['parts_paths', 'part_names', 'part_count']

✅ Stage 3: rigging
   Status: COMPLETED
   Time: 0.61s
   Outputs: ['skeleton_path', 'joint_count', 'bone_count']

✅ Stage 4: urdf
   Status: COMPLETED
   Time: 0.52s
   Outputs: ['urdf_path', 'link_count', 'joint_count']

✅ Stage 5: simulation
   Status: COMPLETED
   Time: 0.43s
   Outputs: ['simulation_model_path', 'environment_type']

✅ Stage 6: training
   Status: COMPLETED
   Time: 2.15s
   Outputs: ['policy_path', 'training_episodes', 'final_reward']

🏁 Pipeline Summary:
   Total stages: 6
   Successful: 6
   Failed: 0
   Total time: 5.56s

🎭 Final Hero Status:
============================================================
Hero: tung_sahur_demo
Status: ready
Processing log entries: 12

📦 Generated Assets:
✅ Input Image: image.png
✅ 3D Mesh: generated_mesh.obj
✅ Parts: 4 files
   - head.obj
   - torso.obj
   - arms.obj
   - legs.obj
✅ Skeleton: skeleton.json
✅ URDF: robot.urdf
✅ Simulation Model: scene.xml
✅ Trained Policy: policy.pkl

💾 Saved hero metadata: heroes/tung_sahur_demo/hero.json

🎉 Pipeline demo completed successfully!
📁 Check the results in: heroes/tung_sahur_demo
```

## Generated Files

After completion, explore the generated assets:

### Directory Structure

```
heroes/tung_sahur_demo/
├── input_image.png          # Original character image (54KB)
├── generated_mesh.obj       # Generated 3D mesh (987 bytes)
├── parts/                   # Decomposed body parts
│   ├── head.obj            # Head geometry (94 bytes)
│   ├── torso.obj           # Torso geometry (97 bytes)
│   ├── arms.obj            # Arms geometry (94 bytes)
│   └── legs.obj            # Legs geometry (96 bytes)
├── skeleton.json           # Biped skeleton (3,993 bytes)
├── robot.urdf              # Robot description (1,669 bytes)
├── scene.xml               # MuJoCo scene (1,429 bytes)
├── policy.pkl              # Trained policy (841 bytes)
└── hero.json               # Processing metadata (2,261 bytes)
```

### File Details

#### 1. Generated 3D Mesh (`generated_mesh.obj`)

Standard Wavefront OBJ format with humanoid geometry:

```obj
# Simple Humanoid Mesh
# Generated by Tung Playground Mock Generator

# Vertices (head, torso, arms, legs)
v 0.0 1.8 0.0      # Head top
v 0.0 1.6 0.0      # Head bottom
v 0.15 1.7 0.0     # Head side
v -0.15 1.7 0.0    # Head side
# ... more vertices
```

#### 2. Skeleton Structure (`skeleton.json`)

Complete biped skeleton with joint hierarchy:

```json
{
  "skeleton_type": "biped",
  "joint_count": 20,
  "bone_count": 19,
  "joints": {
    "root": {
      "position": [0.0, 0.0, 0.0],
      "parent": null,
      "children": ["pelvis"]
    },
    "pelvis": {
      "position": [0.0, 0.8, 0.0],
      "parent": "root",
      "children": ["spine", "left_hip", "right_hip"]
    }
    // ... more joints
  }
}
```

#### 3. Robot Description (`robot.urdf`)

Complete URDF with physics properties:

```xml
<?xml version="1.0"?>
<robot name="tung_hero">
  <link name="base_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="generated_mesh.obj" scale="1 1 1"/>
      </geometry>
      <material name="hero_material">
        <color rgba="0.8 0.6 0.2 1.0"/>
      </material>
    </visual>
    <!-- collision and inertial properties -->
  </link>
  <!-- joints and additional links -->
</robot>
```

#### 4. Processing Metadata (`hero.json`)

Complete audit trail of pipeline execution:

```json
{
  "id": "hero_123456",
  "name": "tung_sahur_demo",
  "status": "ready",
  "assets": {
    "input_image": "input_image.png",
    "mesh_3d": "generated_mesh.obj",
    "parts": ["parts/head.obj", "parts/torso.obj", "parts/arms.obj", "parts/legs.obj"],
    "skeleton": "skeleton.json",
    "urdf": "robot.urdf",
    "simulation_model": "scene.xml",
    "trained_policy": "policy.pkl",
    "metadata": {
      "generation": {
        "generator": "mock_generator",
        "quality_score": 0.85,
        "vertices": 156,
        "faces": 280
      }
      // ... metadata for each stage
    }
  },
  "processing_log": [
    {
      "timestamp": "2025-01-15T12:00:00",
      "stage": "generation",
      "message": "3D mesh generated successfully"
    }
    // ... complete processing history
  ]
}
```

## Code Walkthrough

Let's examine the key parts of the demo script:

### 1. Hero Creation

```python
hero = tp.create_hero(
    name=hero_name,
    image_path=str(image_path),
    hero_dir=f"heroes/{hero_name}"
)
```

This creates a new `Hero` instance with:
- Unique identifier
- Asset tracking system
- Processing log initialization
- Directory structure setup

### 2. Pipeline Configuration

```python
pipeline = tp.create_pipeline()

# Add all mock pipeline stages
pipeline.add_stage(MockGenerator("generation", config.get("stages", {}).get("generation", {})))
pipeline.add_stage(MockDecomposer("decomposition", config.get("stages", {}).get("decomposition", {})))
# ... more stages
```

Each stage receives:
- Stage-specific configuration
- Access to shared resources
- Validation rules
- Retry policies

### 3. Execution and Results

```python
results = await pipeline.execute(hero)

for result in results:
    print(f"✅ Stage: {result.stage_name}")
    print(f"   Status: {result.status}")
    print(f"   Time: {result.execution_time:.2f}s")
```

The pipeline returns detailed results including:
- Execution status for each stage
- Processing time and metrics
- Generated outputs and metadata
- Error information if applicable

## Customization

### Configuration Override

Create custom configuration:

```yaml
# config/demo.yaml
stages:
  generation:
    quality_threshold: 0.9
    output_format: "ply"
  
  training:
    total_timesteps: 2000000
    learning_rate: 0.0001
```

Load with:

```python
config = tp.load_config("demo")
pipeline = tp.create_pipeline(config)
```

### Custom Input Image

Use your own character:

```python
# Replace with your image path
image_path = Path("path/to/your/character.png")
hero_name = "my_custom_hero"

hero = tp.create_hero(hero_name, str(image_path))
```

### Selective Stage Execution

Run only specific stages:

```python
pipeline = tp.create_pipeline()
pipeline.add_stage(MockGenerator("generation"))
pipeline.add_stage(MockDecomposer("decomposition"))
# Skip later stages for faster testing

results = await pipeline.execute(hero)
```

## Performance Analysis

### Stage Timing Breakdown

| Stage | Time | Percentage | Bottleneck |
|-------|------|------------|------------|
| Generation | 1.02s | 18% | AI model inference |
| Decomposition | 0.83s | 15% | Mesh processing |
| Rigging | 0.61s | 11% | Joint calculation |
| URDF | 0.52s | 9% | XML generation |
| Simulation | 0.43s | 8% | Scene setup |
| Training | 2.15s | 39% | RL algorithm |

### Optimization Opportunities

1. **Parallel Execution**: Independent stages can run concurrently
2. **GPU Acceleration**: Use GPU for AI model inference
3. **Caching**: Cache intermediate results for repeated runs
4. **Batch Processing**: Process multiple heroes simultaneously

## Next Steps

- **[Custom Pipeline](./custom-pipeline.md)**: Build your own pipeline
- **[Batch Processing](./batch-processing.md)**: Handle multiple heroes
- **[Advanced Configuration](./advanced-config.md)**: Fine-tune parameters
- **[Integration Guide](../integration/mujoco.md)**: Connect with external tools

## Troubleshooting

### Common Issues

**Problem**: `FileNotFoundError: image not found`
**Solution**: Ensure the sample image exists or provide a valid path

**Problem**: Pipeline hangs at training stage
**Solution**: Reduce `total_timesteps` in configuration

**Problem**: Out of memory errors
**Solution**: Set `max_workers: 1` in pipeline configuration

For more help, see the [Troubleshooting Guide](../troubleshooting/common-issues.md).
# Hero Visualization

The Tung Playground framework provides interactive 3D visualization for generated heroes using the powerful [viser](https://github.com/nerfstudio-project/viser) library. This enables real-time exploration and manipulation of URDF robot models through a web-based interface.

## Features

- **Interactive Joint Control**: Real-time manipulation of robot joints with sliders
- **Mesh Visualization**: Toggle between visual and collision meshes
- **Web-Based Interface**: Access visualization from any browser
- **Hero Integration**: Seamlessly visualize heroes generated by the pipeline
- **Real-Time Updates**: See changes instantly as you adjust joint positions

## Installation

The visualization functionality requires additional dependencies. Install them with:

```bash
# Install with visualization dependencies
pip install tung_playground[vis]

# Or if using uv
uv sync --extra vis
```

## Quick Start

### Visualize an Existing Hero

```python
import tung_playground as tp

# Load a hero (assuming it has a URDF)
hero_dir = "heroes/tung_sahur_demo"
hero = tp.Hero.load(hero_dir / "hero.json")

# Start interactive visualization
hero.visualize()
```

### Using the Command Line Tool

List available heroes:
```bash
python examples/visualize_hero.py --list
```

Visualize a specific hero:
```bash
python examples/visualize_hero.py tung_sahur_demo
```

Customize server settings:
```bash
python examples/visualize_hero.py tung_sahur_demo --port 8081 --host 0.0.0.0
```

## Programming Interface

### Basic Usage

```python
from tung_playground.visualization import URDFVisualizer

# Create visualizer
visualizer = URDFVisualizer(port=8080, host="localhost")

# Load URDF directly
visualizer.load_urdf("path/to/robot.urdf", base_dir="path/to/meshes")

# Or load from hero
visualizer.load_hero(hero)

# Start the server
visualizer.run(blocking=True)
```

### Non-Blocking Operation

```python
# Start server in background
visualizer = hero.visualize(blocking=False)

# Do other work...
import time
time.sleep(10)

# Stop when done
visualizer.stop()
```

### Programmatic Joint Control

```python
# Set joint positions programmatically
joint_positions = {
    "left_shoulder": 0.5,
    "right_shoulder": -0.5,
    "left_hip": 0.2
}
visualizer.set_joint_positions(joint_positions)
```

## Web Interface Features

When you start the visualization, open the provided URL in your browser to access:

### Joint Controls
- **Sliders**: One slider per controllable joint with proper limits
- **Real-time Updates**: See changes immediately as you move sliders
- **Reset Button**: Return all joints to initial positions

### Display Options
- **Visual Meshes**: Toggle display of visual geometry
- **Collision Meshes**: Toggle display of collision geometry
- **Grid and Lighting**: Built-in scene elements for better visualization

### Navigation
- **Mouse Controls**: 
  - Left click + drag: Rotate view
  - Right click + drag: Pan view
  - Scroll wheel: Zoom in/out

## Examples

### Complete Pipeline + Visualization

```python
import asyncio
import tung_playground as tp

async def generate_and_visualize():
    # Create hero
    hero = tp.create_hero(
        name="my_robot",
        image_path="path/to/image.png"
    )
    
    # Run pipeline to generate URDF
    pipeline = tp.create_pipeline("default")
    await pipeline.execute(hero)
    
    # Visualize result
    hero.visualize()

# Run the demo
asyncio.run(generate_and_visualize())
```

### Batch Visualization

```python
from pathlib import Path

# Find all heroes with URDFs
heroes_dir = Path("heroes")
for hero_dir in heroes_dir.iterdir():
    if (hero_dir / "robot.urdf").exists():
        print(f"Starting visualization for {hero_dir.name}")
        hero = tp.Hero(name=hero_dir.name, hero_dir=hero_dir)
        hero.assets.set_asset(tp.AssetType.URDF, hero_dir / "robot.urdf")
        
        # Non-blocking visualization on different ports
        port = 8080 + hash(hero_dir.name) % 100
        hero.visualize(port=port, blocking=False)
        print(f"Visit http://localhost:{port}")
```

## Troubleshooting

### Visualization Dependencies Not Found

```bash
# Ensure visualization dependencies are installed
pip install tung_playground[vis]

# Or install specific packages
pip install viser yourdfpy
```

### "could not convert string to float" Error

This error typically occurs when OBJ mesh files contain malformed comments or formatting:

```bash
# Error message example:
# ValueError: could not convert string to float: '#'
```

**Solutions:**
1. **Regenerate mesh files**: Run the pipeline again to generate clean mesh files
2. **Check OBJ file format**: Ensure OBJ files don't have inline comments after vertex data
3. **Use fallback visualization**: The visualizer will attempt to show a simplified view

**Example fix:**
```python
# Bad OBJ format:
# v 0.0 1.8 0.0  # Head vertex

# Good OBJ format:
# v 0.0 1.8 0.0
```

### Hero Missing URDF Asset

Make sure your hero has been processed through the pipeline up to URDF generation:

```python
# Check if hero has URDF
if not hero.assets.has_asset(tp.AssetType.URDF):
    print("Hero needs URDF generation")
    # Run pipeline or set URDF manually
    hero.assets.set_asset(tp.AssetType.URDF, Path("path/to/robot.urdf"))
```

### Mesh Files Not Found

Ensure mesh files are in the correct location relative to the URDF:

```python
# When loading URDF, specify base directory for mesh resolution
visualizer.load_urdf(urdf_path, base_dir=hero.hero_dir)
```

### Port Already in Use

```bash
# Use a different port
python examples/visualize_hero.py tung_sahur_demo --port 8081
```

## Advanced Configuration

### Custom Visualizer Settings

```python
from tung_playground.visualization import URDFVisualizer

# Create with custom settings
visualizer = URDFVisualizer(
    port=8080,
    host="0.0.0.0"  # Allow external connections
)

# Customize scene
visualizer.server.scene.add_directional_light(
    name="custom_light",
    color="#ff0000",
    intensity=2.0,
    position=(1, 1, 1)
)
```

### Integration with Hero Pipeline

```python
# Add visualization as a pipeline stage
class VisualizationStage(tp.PipelineStage):
    async def process(self, hero: tp.Hero):
        if hero.assets.has_asset(tp.AssetType.URDF):
            hero.visualize(blocking=False)
        return {"visualization_started": True}
```

## API Reference

### URDFVisualizer

Main class for URDF visualization:

```python
class URDFVisualizer:
    def __init__(self, port: int = 8080, host: str = "localhost")
    def load_hero(self, hero: Hero) -> None
    def load_urdf(self, urdf_path: Path, base_dir: Optional[Path] = None) -> None
    def set_joint_positions(self, joint_positions: Dict[str, float]) -> None
    def run(self, blocking: bool = True) -> None
    def stop(self) -> None
```

### Hero.visualize()

Convenience method for hero visualization:

```python
def visualize(self, port: int = 8080, host: str = "localhost", 
              blocking: bool = True) -> URDFVisualizer
```

### Utility Functions

```python
# Convenience functions
def visualize_hero(hero: Hero, **kwargs) -> URDFVisualizer
def visualize_urdf(urdf_path: Path, **kwargs) -> URDFVisualizer
```